<html lang="en">

<head>
    <meta charset='utf-8' />
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/series-label.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="../../dist/ol/include-ol.js"></script>
    <script src="../../examples/js/common.js"></script>
    <title>Highcharts Pie</title>
</head>
<style>
    .map {
        width: 100%;
        height: calc(100vh - 20px);
    }
    
    body {
        overflow: hidden;
        margin: 8px;
    }
    
    #container {
        position: absolute;
        top: 60%;
        bottom: 0;
        width: 100%;
        height: 40%;
        z-index: 1000;
    }
</style>

<body>
    <div id='divMapId' class='map'></div>
    <div id='start'>
        <div id='container'></div>
    </div>
    <script type="text/javascript" include="echarts" src="../js/include-web.js"></script>
    <script type="text/javascript">
        var featureLayers, dataSource;
        var map = new ol.Map({
            target: 'divMapId',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: [105.20886162772933, 16.518572979240204],
                zoom: 6,
                projection: 'EPSG:4326',
                multiWorld: true
            })
        });
        var vnMap = new ol.ekmap.TiledVietNamMapLayer({
            token: tokenVN
        }).addTo(map)
        var categoryDataMap = {
            "Hà Nội": [{
                y: 335,
                name: 'class A'
            }, {
                y: 679,
                name: 'class B'
            }, {
                y: 1299,
                name: 'class C'
            }],
            "Đà Nẵng": [{
                y: 117,
                name: 'class A'
            }, {
                y: 1267,
                name: 'class B'
            }, {
                y: 1048,
                name: 'class C'
            }],
            "Thành phố Hồ Chí Minh": [{
                y: 475,
                name: 'class A'
            }, {
                y: 1450,
                name: 'class B'
            }, {
                y: 875,
                name: 'class C'
            }]
        };
        var dataMap = {
            "Hà Nội": [{
                y: 335,
                name: 'commodity A',
                sliced: true,
                selected: true
            }, {
                y: 310,
                name: 'commodity B'
            }, {
                y: 234,
                name: 'commodity C'
            }, {
                y: 135,
                name: 'commodity D'
            }, {
                y: 1048,
                name: 'commodity E'
            }, {
                y: 251,
                name: 'commodity F'
            }],
            "Đà Nẵng": [{
                y: 117,
                name: 'commodity A'
            }, {
                y: 284,
                name: 'commodity B'
            }, {
                y: 768,
                name: 'commodity C'
            }, {
                y: 215,
                name: 'commodity D'
            }, {
                y: 901,
                name: 'commodity E'
            }, {
                y: 148,
                name: 'commodity F'
            }],
            "Thành phố Hồ Chí Minh": [{
                y: 475,
                name: 'commodity A'
            }, {
                y: 29,
                name: 'commodity B'
            }, {
                y: 430,
                name: 'commodity C'
            }, {
                y: 981,
                name: 'commodity D'
            }, {
                y: 732,
                name: 'commodity E'
            }, {
                y: 143,
                name: 'commodity F'
            }]
        };
        query();

        function iconStyleFunc() {
            var zIndex = 1;
            var iconStyle = [new ol.style.Style({
                image: new ol.style.Icon(({
                    anchor: [0.5, 0.5],
                    anchorXUnits: 'fraction',
                    anchorYUnits: 'pixels',
                    scale: 0.1,
                    src: './img/marker-icon-red.png',
                    zIndex: zIndex
                })),
                zIndex: zIndex
            })];
            return iconStyle;
        }

        function query() {
            $.get("https://demo.ekgis.vn/ekmapsdks/data/echarts_pie.json", function(response) {
                dataSource = new ol.source.Vector({
                    features: new ol.format.GeoJSON().readFeatures(response),
                });
                featureLayers = new ol.layer.Vector({
                    source: dataSource,
                    style: iconStyleFunc()
                });
                map.addLayer(featureLayers)
            })
            map.on('click', function(e) {
                var feature = map.forEachFeatureAtPixel(e.pixel, function(feature) {
                    return feature;
                });
                if (feature) {
                    var city = feature.getProperties().NAME;
                    var options = {
                        chart: {
                            renderTo: 'container',
                            plotBackgroundColor: null,
                            plotBorderWidth: null,
                            plotShadow: false,
                            type: 'pie'
                        },
                        title: {
                            text: city
                        },
                        subtitle: {
                            text: 'Commodity sales'
                        },
                        tooltip: {
                            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                        },
                        accessibility: {
                            point: {
                                valueSuffix: '%'
                            }
                        },
                        plotOptions: {
                            pie: {
                                allowPointSelect: true,
                                cursor: 'pointer',
                                dataLabels: {
                                    enabled: true,
                                    format: '<b>{point.name}</b>: {point.percentage:.1f} %'
                                },
                                showInLegend: true
                            }
                        },
                        series: [{
                            type: 'pie',
                            name: 'comodity class',
                            colorByPoint: true,
                            data: categoryDataMap[city]
                        }, {
                            type: 'pie',
                            size: '100%',
                            innerSize: '70%',
                            name: 'commodity',
                            data: dataMap[city]
                        }]
                    };
                    var chart = new Highcharts.Chart(options);
                }
            });
        }
    </script>
</body>

</html>